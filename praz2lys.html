<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier Praz de Lys</title>
    <link rel="icon" href="logo.png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
                body {
            font-family: Arial, sans-serif;
            background-image: url('image.JPG'); /* Image de fond */
            background-size: cover;
            margin: 0;
            padding: 20px;
            color: white; /* Couleur de texte blanche pour contraste */
        }
        #loginContainer {
            display: flex;
            flex-direction: column;
            max-width: 300px;
            margin: auto;
            background-color: rgba(0, 0, 0, 0.7); /* Fond semi-transparent */
            padding: 20px;
            border-radius: 10px;
        }
        #calendarContainer {
            display: none;
            margin-top: 20px;
            background-color: rgba(0, 0, 0, 0.7); /* Fond semi-transparent */
            padding: 20px;
            border-radius: 10px;
        }
        .week {
            padding: 10px;
            border: 1px solid #ccc;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 5px;
            position: relative; /* Nécessaire pour le positionnement absolu de .locataire-name */
            padding-right: 50px; /* Laisse un peu d’espace à droite si besoin */
        }
        .week.disponible {
            background-color: #00ff0080; /* Couleur pour les semaines disponibles */
        }
        .quasi-louee{
            background-color: #ff7300a1; /* Couleur pour les semaines louées */
        }
        /* Couleurs des boutons */
        .week.louee {
            background-color: #ff000080; /* Couleur pour les semaines louées */
        }


        /* Modale */
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* Arrière-plan semi-transparent */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #modalContent {
            background: white;
            color: black;
            padding: 20px;
            border-radius: 5px;
            width: 300px;
            max-height: 90vh; /* Empêche la modale de dépasser l'écran */
            overflow-y: auto; /* Active le scroll à l'intérieur si besoin */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.5s;
        }
        
        /* Modale principale */
        #modalajout {
            display: none; /* Cachée par défaut */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.4); /* Fond assombri */
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }

        /* Contenu de la modale */
        #modalContentajout {
            background: white;
            color: black;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 80vh;
            overflow-y: auto; /* Ajoute un scroll si nécessaire */
        }

        /* Animation d’apparition de la modale */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Groupes pour aligner label + input sur la même ligne */
        .form-group {
            display: flex;
            flex-wrap: wrap; /* Si nécessaire, passe à la ligne */
            justify-content: space-between;
            gap: 10px;
            align-items: center;
        }

        .form-group label {
            flex: 1;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .form-group input, .form-group select {
            flex: 2;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
        }

        /* Styles pour les boutons */
        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.3s ease;
        }

        /* Boutons spécifiques */
        #save-locataire {
            background-color: #28a745;
            color: white;
        }

        #close-modalajout {
            background-color: #dc3545;
            color: white;
        }
#close-modal {
            background-color: #6c757d;
            color: white;
        }

        #close-modal:hover {
            background-color: #545b62;
        }
        button:hover {
            opacity: 0.8;
        }

        /* Ajustements pour les écrans plus petits */
        @media (max-width: 768px) {
        #modalajout {
                width: 95%;
            }
        #modalContentajout {
                padding: 15px;
            }
        .form-group {
                flex-direction: column; /* Empiler les éléments sur petits écrans */
            }
        button {
                margin-top: 10px;
            }
        }

        button {
            margin-top: 10px;
            padding: 10px;
            background-color: #007BFF;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }

        #summary {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            color: white;
            z-index: 1000;
        }

         /* Style des flèches */
         .arrow-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .arrow {
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
            margin: 0 10px;
            background-color: #f0f0f0;
            border-radius: 50%;
            border: none;
            transition: background-color 0.3s;
        }

        .arrow:hover {
            background-color: #dcdcdc;
        }

        .date-info {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .date-info span {
            margin: 0 10px;
        }

        .nextTabBtn, .prevTabBtn {
            display: none; /* Caché par défaut */
            position: fixed; /* Fixé en bas de la page */
            bottom: 20px; /* Distance depuis le bas */
            background-color: #007bff; /* Bleu vif */
            color: white; /* Texte blanc */
            padding: 15px 20px; /* Agrandir un peu */
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 50px; /* Boutons arrondis */
            cursor: pointer;
            z-index: 1000; /* Toujours visible */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Petit effet d'ombre */
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        
        /* Positionnement des boutons */
        .btnprev {
            left: 10%; /* Aligné à gauche */
        }
        
        .btnnext {
            right: 10%; /* Aligné à droite */
        }
        
        /* Effet au survol */
        .btnnext:hover, .btnprev:hover {
            background-color: #0056b3; /* Bleu plus foncé */
            transform: scale(1.1); /* Légère augmentation de taille */
        }
        
        /* Afficher les boutons uniquement après connexion */
        #calendarContainer.active .btnnext,
        #calendarContainer.active .btnprev {
            display: block; 
        }
        .locataire-container {
            display: flex;  /* Aligner texte + pastille sur la même ligne */
            align-items: center;  /* Centrage vertical */
            justify-content: flex-end;  /* Aligner à droite */
            gap: 5px;  /* Espacement entre texte et pastille */
            width: 100%; /* Pour occuper toute la largeur dispo */
        }
        
        .locataire-name {
            font-size: 15px;
            color: black;
            font-weight: bold;

        }
        
        .pastille {
            width: 13px;
            height: 13px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #errorMessage {
            color: red;
            text-align: center;
            margin-top: 10px;
        }
        

        .btnprev:disabled, .btnnext:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }


        .loading {
            text-align: center;
            padding: 50px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }


        #editWeekBtn {
            background-color: #007bff;
            color: white;
        }

        #editWeekBtn:hover {
            background-color: #0056b3;
        }


/* Modale d'édition */
#Modifmodal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7); /* Arrière-plan semi-transparent */
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

/* Contenu de la modale d'édition */
#ModifmodalContent {
    background: white;
    color: black;
    padding: 20px;
    border-radius: 5px;
    width: 320px;
    max-height: 90vh; /* Empêche la modale de dépasser l'écran */
    overflow-y: auto; /* Active le scroll à l'intérieur si besoin */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    animation: fadeIn 0.5s;
}

/* Groupes de champs de formulaire */
.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-sizing: border-box;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
}

/* Groupe des cases à cocher */
.checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.checkbox-group input[type="checkbox"] {
    width: auto;
}

/* Actions (boutons) */
.form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.btn-save {
    background-color: #007bff;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.btn-save:hover {
    background-color: #0056b3;
}

.btn-cancel {
    background-color: #6c757d;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.btn-cancel:hover {
    background-color: #545b62;
}

/* Animation fadeIn */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}


        @media (max-width: 768px) {
            #week-list {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            #summary {
                flex-direction: column;
                gap: 10px;
            }
            
            #modalContent, #ModifmodalContent {
                margin: 20px;
                max-width: calc(100% - 40px);
            }
        }
        
    </style>
</head>
<body>
    <div id="loginContainer">
    <h2>Connexion</h2>
    <input type="text" id="username" placeholder="Nom d'utilisateur" required>
    <input type="password" id="password" placeholder="Mot de passe" required>
    <div style="display: flex; align-items: center; margin-top: 10px;">
        <input type="checkbox" id="showPassword" style="margin-right: 8px;">
        <label for="showPassword" style="cursor: pointer;">Afficher le mot de passe</label>
    </div>
    <button id="loginButton">Se connecter</button>
    <p id="errorMessage"></p>
</div>

    <div id="calendarContainer">
        <div class="header">
            <h2 id="date">Calendrier des Semaines Louées</h2>
            <div class="nav-buttons">
                <button class="btnprev" id="prevTabBtn">← Précédent</button>
                <button class="btnnext" id="nextTabBtn">Suivant →</button>
            </div>
        </div>

        <div id="summary">
            <div>Total du Loyer : <span id="total-loyers">0</span>€</div>
            <div id="nombre-semaines-louees">Semaines louées : 0</div>
        </div>

        <div class="loading" id="loading">Chargement des données...</div>
        <div id="week-list"></div>
    </div>

    <!-- Modal de détails -->
    <div id="modal">
        <div id="modalContent">
            <h3>Détails de la Semaine</h3>
            <p><strong>Semaine:</strong> <span id="week-display"></span></p>
            <p><strong>Date de Début:</strong> <span id="start-display"></span></p>
            <p><strong>Date de Fin:</strong> <span id="end-display"></span></p>
            <p><strong>Nom:</strong> <span id="nom-display"></span></p>
            <p><strong>Téléphone:</strong> <span id="telephone-display"></span></p>
            <p><strong>Adresse:</strong> <span id="adresse-display"></span></p>
            <p><strong>Email:</strong> <span id="email-display"></span></p>
            <p><strong>Support:</strong> <span id="support-display"></span></p>
            <p><strong>Nombre de personnes:</strong> <span id="nb-personnes-display"></span></p>
            <p><strong>Loyer brut:</strong> <span id="loyer-brut-display"></span>€</p>
            <p><strong>Taxe de séjour:</strong> <span id="taxe-display"></span>€</p>
            <p><strong>Calcul arrhes</strong> <span id="calcul-arrhes-display"></span>€</p>
            <p><strong>Loyer total:</strong> <span id="loyer-total-display"></span>€</p>
            <p><strong>Montant arrhes:</strong> <span id="montant-arrhes-display"></span>€</p>
            <p><strong>Reste dû:</strong> <span id="reste-du-display"></span>€</p>
            <p><strong>Date de paiement:</strong> <span id="date-paiement-display"></span></p>
            <p><strong>Contrat envoyé:</strong> <span id="contrat-envoye-display"></span></p>
            <p><strong>Retour contrat:</strong> <span id="retour-contrat-display"></span></p>
            <p><strong>Caution reçue:</strong> <span id="caution-recue-display"></span></p>
            <p><strong>Attestation assurance:</strong> <span id="attestation-assurance-display"></span></p>
            <p><strong>Validé:</strong> <span id="valide-display"></span></p>
            
            <button id="editWeekBtn">Modifier</button>
            <button id="generatePdfBtn">Télécharger PDF</button>
            <button id="close-modal">Fermer</button>
        </div>
    </div>

    <!-- Modal d'édition -->
    <div id="Modifmodal">
        <div id="ModifmodalContent">
            <h3>Modifier la Semaine <span id="edit-week-title"></span></h3>
            <div class="form-group">
                <label for="edit-nom">Nom :</label>
                <input type="text" id="edit-nom" placeholder="Nom du locataire">
            </div>
            <div class="form-group">
                <label for="edit-telephone">Téléphone :</label>
                <input type="tel" id="edit-telephone" placeholder="Numéro de téléphone">
            </div>
            <div class="form-group">
                <label for="edit-adresse">Adresse :</label>
                <input type="text" id="edit-adresse" placeholder="Adresse complète">
            </div>
            <div class="form-group">
                <label for="edit-email">Email :</label>
                <input type="email" id="edit-email" placeholder="Adresse email">
            </div>
            <div class="form-group">
                <label for="edit-support">Support :</label>
                <input type="text" id="edit-support" placeholder="Support de réservation">
            </div>
            <div class="form-group">
                <label for="edit-nb-personnes">Nombre de personnes :</label>
                <input type="number" id="edit-nb-personnes" min="1" max="20">
            </div>
            <div class="form-group">
                <label for="edit-loyer-brut">Loyer brut (€) :</label>
                <input type="number" id="edit-loyer-brut" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label for="edit-date-paiement">Date de paiement :</label>
                <input type="date" id="edit-date-paiement">
            </div>
            <div class="form-group">
                <label for="edit-date-contrat">Date du contrat :</label>
                <input type="date" id="edit-date-contrat">
            </div>
            <div class="form-group checkbox-group">
                <label for="edit-contrat-envoye">Contrat envoyé</label>
                <input type="checkbox" id="edit-contrat-envoye">
                
            </div>
            <div class="form-group checkbox-group">
                <label for="edit-retour-contrat">Retour contrat</label>
                <input type="checkbox" id="edit-retour-contrat">
                
            </div>
            <div class="form-group checkbox-group">
                <label for="edit-caution-recue">Caution reçue</label>
                <input type="checkbox" id="edit-caution-recue">
                
            </div>
            <div class="form-group checkbox-group">
                <label for="edit-attestation-assurance">Attestation assurance</label>
                <input type="checkbox" id="edit-attestation-assurance">
                
            </div>
            <div class="form-group checkbox-group">
                <label for="edit-valide">Validé</label>
                <input type="checkbox" id="edit-valide">
            </div>
            <div class="form-actions">
                <button class="btn-cancel" id="cancel-edit">Annuler</button>
                <button class="btn-save" id="save-edit">Sauvegarder</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Configuration Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAsuyOYBd_VLGPgXSFB9yqHQ9U7QHo8bS4",
            authDomain: "praz2lys.firebaseapp.com",
            projectId: "praz2lys",
            storageBucket: "praz2lys.firebasestorage.app",
            messagingSenderId: "471287992000",
            appId: "1:471287992000:web:9406fedb64109c03802725",
            measurementId: "G-6STVEVH6RR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Configuration des utilisateurs et des années
        const correctUsers = {
            Xaviere: 'emilienbisson76',
            Milou: 'Lecodeur76',
            Nonola: 'miamleschocapics',
            Anthony: 'ynohtna',
            Daronne: 'Miloulebest'
        };

        const collections = ['2024-2025', '2025-2026', '2026-2027', '2027-2028', '2028-2029', '2029-2030', 'testsamere'];
        const semaines = [
            "S51", "S52", ...Array.from({ length: 17 }, (_, i) => `S${i + 1}`),
            ...Array.from({ length: 7 }, (_, i) => `S${i + 27}`)
        ];

        // Variables globales
        let currentTabIndex = 0;
        let weeks = [];
        let currentWeek = null;
        const sessionDuration = 20 * 60 * 1000; // 20 minutes

  // Fonction pour calculer les dates de début et fin de semaine
function getWeekDates(weekNumber, year) {
    const startYear = parseInt(year.split('-')[0]);
    let weekNum = parseInt(weekNumber.replace('S', ''));
    
    // Dates de début pour chaque saison selon l'année
    const seasonStarts = {
        2024: { 
            winter: new Date(2024, 11, 14), // 14 déc 2024
            summer: new Date(2025, 6, 5)    // 5 juil 2025
        },
        2025: { 
            winter: new Date(2025, 11, 13), // 13 déc 2025
            summer: new Date(2026, 6, 4)    // 4 juil 2026
        },
        2026: { 
            winter: new Date(2026, 11, 12), // 12 déc 2026
            summer: new Date(2027, 6, 3)    // 3 juil 2027
        },
        2027: { 
            winter: new Date(2027, 11, 11), // 11 déc 2027
            summer: new Date(2028, 6, 1)    // 1 juil 2028
        },
        2028: { 
            winter: new Date(2028, 11, 9),  // 9 déc 2028
            summer: new Date(2029, 6, 7)    // 7 juil 2029
        },
        2029: { 
            winter: new Date(2029, 11, 8),  // 8 déc 2029
            summer: new Date(2030, 6, 6)    // 6 juil 2030
        }
    };

    if (!seasonStarts[startYear]) {
        return { start: '', end: '' };
    }

    let startDate;
    
    // Période hiver/printemps (S51, S52, S1-S17)
    if (weekNum >= 51 || weekNum <= 17) {
        startDate = new Date(seasonStarts[startYear].winter);
        
        // Calculer l'offset en semaines depuis S51
        let weekOffset;
        if (weekNum >= 51) {
            weekOffset = weekNum - 51; // S51 = 0, S52 = 1
        } else {
            // S1, S2, S3... suivent directement S52
            weekOffset = weekNum + 1; // S1 = 2, S2 = 3, S3 = 4, etc.
        }
        
        startDate.setDate(startDate.getDate() + (weekOffset * 7));
    }
    // Période été (S27-S33)
    else if (weekNum >= 27 && weekNum <= 33) {
        startDate = new Date(seasonStarts[startYear].summer);
        let weekOffset = weekNum - 27; // S27 = 0, S28 = 1, etc.
        startDate.setDate(startDate.getDate() + (weekOffset * 7));
    }
    else {
        return { start: '', end: '' };
    }
    
    // Calculer la date de fin (7 jours après le début)
    const endDate = new Date(startDate);
    endDate.setDate(endDate.getDate() + 7);
    
    return {
        start: startDate.toLocaleDateString('fr-FR', { 
            day: 'numeric', 
            month: 'short', 
            year: 'numeric' 
        }),
        end: endDate.toLocaleDateString('fr-FR', { 
            day: 'numeric', 
            month: 'short', 
            year: 'numeric' 
        })
    };
}

// Fonction pour parser une date française en objet Date
function parseFrenchDate(dateStr) {
    if (!dateStr) return null;
    
    // Format attendu: "21 juin 2025" ou "21 déc. 2025"
    const months = {
        'janv.': 0, 'janvier': 0,
        'févr.': 1, 'février': 1,
        'mars': 2,
        'avr.': 3, 'avril': 3,
        'mai': 4,
        'juin': 5,
        'juil.': 6, 'juillet': 6,
        'août': 7,
        'sept.': 8, 'septembre': 8,
        'oct.': 9, 'octobre': 9,
        'nov.': 10, 'novembre': 10,
        'déc.': 11, 'décembre': 11
    };
    
    const parts = dateStr.trim().split(' ');
    if (parts.length !== 3) return null;
    
    const day = parseInt(parts[0]);
    const monthName = parts[1].toLowerCase();
    const year = parseInt(parts[2]);
    
    const month = months[monthName];
    if (month === undefined) return null;
    
    return new Date(year, month, day);
}

// Fonction pour formater un nombre (supprimer les .00 inutiles)
function formatNumber(num) {
    const number = parseFloat(num);
    if (isNaN(number)) return '0';
    
    // Si c'est un nombre entier, ne pas afficher les décimales
    if (number % 1 === 0) {
        return number.toString();
    }
    // Sinon, afficher avec 2 décimales max
    return number.toFixed(2).replace(/\.?0+$/, '');
}
        // Aussi, corrigez la fonction calculateDerivedData :
function calculateDerivedData(weekData) {
    const nbPersonnes = parseInt(weekData['Nb personnes']) || 0;
    const loyerBrut = parseFloat(weekData['Loyer brut']) || 0;
    const taxe = nbPersonnes * 7;
    const loyerTotal = loyerBrut + taxe;
    const montantArrhes = (loyerBrut * 0.25) + taxe; // Correction ici
    const resteDu = loyerTotal - montantArrhes;

    return {
        ...weekData,
        'Taxe séjour': taxe.toString(),
        'Loyer total': loyerTotal.toString(),
        'Montant des arrhes': montantArrhes.toFixed(2),
        'Reste dû': resteDu.toFixed(2)
        // Supprimé 'Calcul des arrhes': calcahhres.toFixed(2) car calcahhres n'existe pas
    };
}

        // Gestion de la session
        function checkSession() {
            const sessionData = JSON.parse(sessionStorage.getItem('session') || 'null');
            if (sessionData && new Date().getTime() - sessionData.timestamp < sessionDuration) {
                showCalendar();
                return true;
            }
            sessionStorage.removeItem('session');
            return false;
        }

        function showCalendar() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('calendarContainer').style.display = 'block';
            document.querySelector('.btnprev').style.display = 'inline-block';
            document.querySelector('.btnnext').style.display = 'inline-block';
            fetchData();
        }

        // Fonction de connexion
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (correctUsers[username] === password) {
                const session = { timestamp: new Date().getTime() };
                sessionStorage.setItem('session', JSON.stringify(session));
                showCalendar();
            } else {
                document.getElementById('errorMessage').innerText = 'Nom d\'utilisateur ou mot de passe incorrect.';
            }
        }
// Toggle password visibility with checkbox
document.getElementById('showPassword').addEventListener('change', (e) => {
    const passwordField = document.getElementById('password');
    passwordField.type = e.target.checked ? 'text' : 'password';
});
        // Récupération des données depuis Firebase
        async function fetchData() {
            try {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('week-list').style.display = 'none';

                const currentCollection = collections[currentTabIndex];
                const weeksData = [];

                for (const semaine of semaines) {
                    try {
                        const docRef = doc(db, currentCollection, semaine);
                        const docSnap = await getDoc(docRef);

                        // Par ceci :
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            const calculatedData = calculateDerivedData(data);
                            
                            // Calculer les dates si elles ne sont pas dans la base
                            const weekDates = getWeekDates(semaine, currentCollection);
                            
                            weeksData.push({
                                semaine: data.Semaine || semaine,
                                start: data['Date début'] || weekDates.start,
                                end: data['Date fin'] || weekDates.end,
                                nom: data.Nom || '',
                                telephone: data.Téléphone || '',
                                adresse: data.Adresse || '',
                                email: data.Email || '',
                                support: data.Support || '',
                                nb_personnes: data['Nb personnes'] || '',
                                loyer_brut: data['Loyer brut'] || '',
                                taxe_sejour: calculatedData['Taxe séjour'] || '0',
                                loyer_total: calculatedData['Loyer total'] || '0',
                                montant_arrhes: calculatedData['Montant des arrhes'] || '0',
                                reste_du: calculatedData['Reste dû'] || '0',
                                date_paiement: data['Date de paiement'] || '',
                                contrat_envoye: data['Contrat envoyé ?'] || '0',
                                retour_contrat: data['Retour contrat : Oui/non'] || '0',
                                caution_recue: data['Caution reçue ?'] || '0',
                                attestation_assurance: data['Attestation assurance'] || '0',
                                valide: data['Validé ? 1 oui 0 non'] || '0',
                                date_contrat: data['Date du contrat'] || '',
                                originalData: data
                            });
                        
                        // Et aussi dans la partie else (document n'existe pas) :
                        } else {
                            // Calculer les dates pour les semaines vides
                            const weekDates = getWeekDates(semaine, currentCollection);

                            const emptyData = {
                                semaine: semaine,
                                start: weekDates.start,
                                end: weekDates.end,
                                nom: '',
                                telephone: '',
                                adresse: '',
                                email: '',
                                support: '',
                                nb_personnes: '',
                                loyer_brut: '',
                                taxe_sejour: '0',
                                loyer_total: '0',
                                montant_arrhes: '0',
                                reste_du: '0',
                                date_paiement: '',
                                contrat_envoye: '0',
                                retour_contrat: '0',
                                caution_recue: '0',
                                attestation_assurance: '0',
                                valide: '0',
                                date_contrat: '',
                                originalData: {}
                            };
                            weeksData.push(emptyData);
                        }
                    } catch (error) {
                        console.error(`Erreur pour la semaine ${semaine}:`, error);
                    }
                }

                weeks = weeksData;
                renderWeeks();
                updateSummary();
                updateTitle();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('week-list').style.display = 'grid';
            } catch (error) {
                console.error("Erreur lors de la récupération des données :", error);
                document.getElementById('loading').innerHTML = 'Erreur lors du chargement des données';
            }
        }

        // Rendu des semaines
        function renderWeeks() {
            const weekList = document.getElementById('week-list');
            weekList.innerHTML = '';

            weeks.forEach(week => {
                const weekDiv = document.createElement('div');
                weekDiv.classList.add('week');

                // Déterminer la classe CSS selon l'état
                if (week.nom && (week.valide == '0' || week.valide == 'non')) {
                    weekDiv.classList.add('quasi-louee');
                } else if (week.nom && (week.valide == '1' || week.valide == 'oui')) {
                    weekDiv.classList.add('louee');
                } else {
                    weekDiv.classList.add('disponible');
                }

                // Ou si tu veux garder "Semaine" mais éviter la duplication :
                const weekInfo = document.createElement('div');
                const weekNumber = week.semaine.startsWith('S') ? week.semaine.substring(1) : week.semaine;
                weekInfo.innerHTML = `Semaine ${weekNumber} (${week.start} - ${week.end})`;

                const locataireContainer = document.createElement('div');
                locataireContainer.classList.add('locataire-container');

                if (week.nom) {
                    const locataireName = document.createElement('span');
                    locataireName.classList.add('locataire-name');
                    locataireName.innerText = week.nom;
                    locataireContainer.appendChild(locataireName);
                }

                // Ajouter pastille pour vacances scolaires (si ce champ existe)
                if (week.originalData && week.originalData.vacsco == '1') {
                    const pastille = document.createElement('span');
                    pastille.classList.add('pastille');
                    pastille.style.backgroundColor = 'blue';
                    pastille.title = 'Vacances scolaires';
                    locataireContainer.appendChild(pastille);
                }

                weekDiv.appendChild(weekInfo);
                weekDiv.appendChild(locataireContainer);
                weekDiv.addEventListener('click', () => showModal(week));
                weekList.appendChild(weekDiv);
            });
        }

        // Mise à jour du résumé
        function updateSummary() {
            let totalLoyers = 0;
            let nombreSemainesLouees = 0;

            weeks.forEach(week => {
                if (week.nom && (week.valide == '1' || week.valide == 'oui')) {
                    const loyer = parseFloat(week.loyer_total) || 0;
                    totalLoyers += loyer;
                    nombreSemainesLouees++;
                }
            });

            document.getElementById('total-loyers').innerText = totalLoyers.toFixed(0);
            document.getElementById('nombre-semaines-louees').innerText = `Semaines louées : ${nombreSemainesLouees}`;
        }

        // Mise à jour du titre
        function updateTitle() {
            const currentYear = collections[currentTabIndex];
            document.getElementById('date').innerText = `Calendrier ${currentYear}`;

            // Gérer les boutons de navigation
            document.getElementById('prevTabBtn').disabled = currentTabIndex === 0;
            document.getElementById('nextTabBtn').disabled = currentTabIndex === collections.length - 1;
        }
        // Affichage de la modale
        function showModal(week) {
            currentWeek = week;

            // Remplir les champs de la modale
            document.getElementById('week-display').innerText = week.semaine;
            document.getElementById('start-display').innerText = week.start;
            document.getElementById('end-display').innerText = week.end;
            document.getElementById('nom-display').innerText = week.nom || 'Non renseigné';
            document.getElementById('telephone-display').innerText = week.telephone || 'Non renseigné';
            document.getElementById('adresse-display').innerText = week.adresse || 'Non renseigné';
            document.getElementById('email-display').innerText = week.email || 'Non renseigné';
            document.getElementById('support-display').innerText = week.support || 'Non renseigné';
            document.getElementById('nb-personnes-display').innerText = week.nb_personnes || 'Non renseigné';
            document.getElementById('loyer-brut-display').innerText = week.loyer_brut || '0';
            document.getElementById('taxe-display').innerText = week.taxe_sejour || '0';
            document.getElementById('loyer-total-display').innerText = week.loyer_total || '0';
            document.getElementById('montant-arrhes-display').innerText = week.montant_arrhes || '0';
            document.getElementById('reste-du-display').innerText = week.reste_du || '0';
            document.getElementById('date-paiement-display').innerText = week.date_paiement || 'Non renseigné';
            document.getElementById('contrat-envoye-display').innerText = (week.contrat_envoye == '1' || week.contrat_envoye == 'oui') ? 'Oui' : 'Non';
            document.getElementById('retour-contrat-display').innerText = (week.retour_contrat == '1' || week.retour_contrat == 'oui') ? 'Oui' : 'Non';
            document.getElementById('caution-recue-display').innerText = (week.caution_recue == '1' || week.caution_recue == 'oui') ? 'Oui' : 'Non';
            document.getElementById('attestation-assurance-display').innerText = (week.attestation_assurance == '1' || week.attestation_assurance == 'oui') ? 'Oui' : 'Non';
            document.getElementById('valide-display').innerText = (week.valide === '1' || week.valide === 'oui') ? 'Oui' : 'Non';

            document.getElementById('modal').style.display = 'flex';
            document.querySelector('.btnprev').style.display = 'none';
            document.querySelector('.btnnext').style.display = 'none';
        }
        // Affichage de la modale d'édition
        function showModifmodal() {
            if (!currentWeek) return;
            document.getElementById('edit-week-title').innerText = currentWeek.semaine;
            // Remplir le formulaire avec les données actuelles
            document.getElementById('edit-nom').value = currentWeek.nom || '';
            document.getElementById('edit-telephone').value = currentWeek.telephone || '';
            document.getElementById('edit-adresse').value = currentWeek.adresse || '';
            document.getElementById('edit-email').value = currentWeek.email || '';
            document.getElementById('edit-support').value = currentWeek.support || '';
            document.getElementById('edit-nb-personnes').value = currentWeek.nb_personnes || '';
            document.getElementById('edit-loyer-brut').value = currentWeek.loyer_brut || '';
            document.getElementById('edit-date-paiement').value = currentWeek.date_paiement || '';
            document.getElementById('edit-date-contrat').value = currentWeek.date_contrat || '';
            
            // Checkboxes
            document.getElementById('edit-contrat-envoye').checked = (currentWeek.contrat_envoye == '1' || currentWeek.contrat_envoye == 'oui');
            document.getElementById('edit-retour-contrat').checked = (currentWeek.retour_contrat == '1' || currentWeek.retour_contrat == 'oui');
            document.getElementById('edit-caution-recue').checked = (currentWeek.caution_recue == '1' || currentWeek.caution_recue == 'oui');
            document.getElementById('edit-attestation-assurance').checked = (currentWeek.attestation_assurance == '1' || currentWeek.attestation_assurance == 'oui');
            document.getElementById('edit-valide').checked = (currentWeek.valide == '1' || currentWeek.valide == 'oui');

            document.getElementById('modal').style.display = 'none';
            document.getElementById('Modifmodal').style.display = 'flex';
        }

        // Sauvegarder les modifications
        async function saveWeekChanges() {
            if (!currentWeek) return;

            try {
                const updatedData = {
                    'Semaine': currentWeek.semaine,
                    'Date début': currentWeek.start,
                    'Date fin': currentWeek.end,
                    'Nom': document.getElementById('edit-nom').value,
                    'Téléphone': document.getElementById('edit-telephone').value,
                    'Adresse': document.getElementById('edit-adresse').value,
                    'Email': document.getElementById('edit-email').value,
                    'Support': document.getElementById('edit-support').value,
                    'Nb personnes': document.getElementById('edit-nb-personnes').value,
                    'Loyer brut': document.getElementById('edit-loyer-brut').value,
                    'Date de paiement': document.getElementById('edit-date-paiement').value,
                    'Date du contrat': document.getElementById('edit-date-contrat').value,
                    'Contrat envoyé ?': document.getElementById('edit-contrat-envoye').checked ? '1' : '0',
                    'Retour contrat : Oui/non': document.getElementById('edit-retour-contrat').checked ? '1' : '0',
                    'Caution reçue ?': document.getElementById('edit-caution-recue').checked ? '1' : '0',
                    'Attestation assurance': document.getElementById('edit-attestation-assurance').checked ? '1' : '0',
                    'Validé ? 1 oui 0 non': document.getElementById('edit-valide').checked ? '1' : '0'
                };

                // Calculer les données dérivées
                const calculatedData = calculateDerivedData(updatedData);
                
                // Ajouter les champs calculés
                updatedData['Taxe séjour'] = calculatedData['Taxe séjour'];
                updatedData['Loyer total'] = calculatedData['Loyer total'];
                updatedData['Montant des arrhes'] = calculatedData['Montant des arrhes'];
                updatedData['Reste dû'] = calculatedData['Reste dû'];

                // Sauvegarder dans Firebase
                const currentCollection = collections[currentTabIndex];
                const docRef = doc(db, currentCollection, currentWeek.semaine);
                await setDoc(docRef, updatedData);

                // Fermer la modale d'édition et rafraîchir les données
                document.getElementById('Modifmodal').style.display = 'none';
                await fetchData();
                console.log('Semaine modifiée avec succès !');
            } catch (error) {
                console.error('Erreur lors de la sauvegarde :', error);
                alert('Erreur lors de la sauvegarde des modifications');
            }
        }
        
// Fonction pour générer le PDF
document.getElementById("generatePdfBtn").addEventListener("click", generatePdf);
function generatePdf() {
    const { jsPDF } = window.jspdf; // Importer jsPDF
    const doc = new jsPDF('portrait', 'mm', 'a4'); // Configurer le PDF en portrait A4
    
    // Calculer les dates -1 mois et +1 mois
    const startDate = parseFrenchDate(currentWeek.start);
    const endDate = parseFrenchDate(currentWeek.end);
    
    let moinsUnMoisStr = 'Date non disponible';
    let plusUnMoisStr = 'Date non disponible';
    
    if (startDate) {
        const moinsUnMois = new Date(startDate);
        moinsUnMois.setMonth(moinsUnMois.getMonth() - 1);
        moinsUnMoisStr = moinsUnMois.toLocaleDateString('fr-FR', { 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        });
    }
    
    if (endDate) {
        const plusUnMois = new Date(endDate);
        plusUnMois.setMonth(plusUnMois.getMonth() + 1);
        plusUnMoisStr = plusUnMois.toLocaleDateString('fr-FR', { 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        });
    }

    // Calculer les arrhes (25% du loyer brut) et formater les nombres
    const loyerBrut = parseFloat(currentWeek.loyer_brut) || 0;
    const calculArrhes = loyerBrut * 0.25;
    const taxeSejour = parseFloat(currentWeek.taxe_sejour) || 0;
    const montantArrhes = parseFloat(currentWeek.montant_arrhes) || 0;
    const resteDu = parseFloat(currentWeek.reste_du) || 0;
    const title = "CONTRAT DE LOCATION SAISONNIERE";
    const fontSize = 16;
    const titleWidth = doc.getTextWidth(title) + 10;
    const titleX = (doc.internal.pageSize.width - titleWidth) / 2;
    const titleY = 20;
    const titleHeight = 10;
    doc.setDrawColor(0);
    doc.rect(titleX, titleY, titleWidth, titleHeight);
    doc.setFontSize(fontSize);
    doc.setFont("helvetica", "bold");
    doc.text(title, titleX + 3, titleY + 7);
    doc.setFontSize(13);
    doc.setFont("arial", "bold"); 
    doc.text(`Entre les soussignés,`, 25, 45);    
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text(`M.et Mme BISSON Xavier`, 15, 55);
    doc.text(`Né le 26 mars 1976 à GISORS 27140 `, 15, 60);
    doc.text("Demeurant 74 rue de l'église 76410", 15, 65);
    doc.setFont("arial", "bold");
    doc.text('CLEON', doc.getTextWidth("Demeurant 74 rue de l'église 76410") + 15, 65);
    doc.text(`Tel : 06.86.92.05.70`, 15, 70);   
    doc.setFont("arial", "normal"); 
    doc.text(`désigné(s) ci-après`, 15, 80);
    doc.setFont("arial", "bold");
    doc.text('le bailleur', doc.getTextWidth("désigné(s) ci-après") + 15, 80);
    doc.text(`et`, 15, 90 );
    doc.setFont("arial", "normal");
    doc.text(`Mr/Mme ${currentWeek.nom}`, 15, 95);
    doc.text(`demeurant ${currentWeek.adresse}`, 15, 100);
    doc.text(`Tel portable : ${currentWeek.telephone}`, 15, 105);
    doc.text(`Mail : ${currentWeek.email}`, 15, 110);
    doc.text(`désigné(s) ci-après`, 15, 115);
    doc.setFont("arial", "bold");
    doc.text('le locataire', doc.getTextWidth("désigné(s) ci-après") + 15, 115);
    doc.text(`il est convenu d'une location meublée dont la désignation suit :`, 22, 125);
    doc.text(`Adresse du logement donné en location :`, 15, 135);
    doc.setFont("arial", "normal");
    doc.text(`Résidence VESINE`, 15, 145);
    doc.text(`Étage : 5ème et dernier....................Porte...64....................Superficie 29m2 (Loi Carrez)`, 15, 155); 
    doc.setFont("arial", "bold"); 
    doc.text(`Type du logement donné en location :`, 15, 165);
    doc.setFont("arial", "normal");
    doc.text('Appartement', 15, 170);
    const textWidth = doc.getTextWidth('Appartement');
    doc.line(15, 171, 15 + textWidth, 171);
    doc.setFont("arial", "bold"); 
    doc.text(`Dépendances dont le locataire a la jouissance exclusive :`, 15, 180);
    doc.setFont("arial", "normal");
    doc.text(`Parking en sous sol n°64               Casier à ski n°64               Balcon`, 15, 185);
    doc.setFont("arial", "bold"); 
    doc.text(`Désignation des locaux et équipements privatifs (nombre de pièces, confort, etc...)`, 15, 190);
    doc.setFont("arial", "normal");
    doc.text("- T2 Séjour ouvert sur kitchenette équipée :",22, 200);
    doc.text("   Cafetière classique à filtre (café moulu), bouilloire, mini four GRILL, appareil à raclette, plancha, 2",15, 210);
    doc.text("plaques de cuisson électrique, Grille pain", 15, 215);
    doc.text("- Coin salon (1 couchage BZ 140), avec TV écran plat + 1 couchage appoint pour enfant,  ",22, 220);
    doc.text("- Une chambre séparée avec lit 140. ",22, 225);
    doc.text("- Une mezzanine avec lit de 140  ",22, 230);
    doc.text("- 1 Salle de douche  ",22, 235);
    doc.text("- 1 WC séparé  ",22, 240);
    doc.text("1 Balcon exposé PLEIN SUD avec vue panoramique sur la montagne. ",15, 250);
    doc.addPage();
    doc.setFontSize(13);
    doc.setFont("arial", "bold"); 
    doc.text("Énumération des parties et équipements communs (ascenseur, local à vélo, escalier principal)", 15, 30);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("Ascenseur, escalier principal", 15, 35);
    doc.text("Obligation de mettre les skis et chaussures de ski dans le CASIER a ski en RDC prévu à cet effet.", 15, 40);
    doc.text("Il est formellement interdit de monter dans l'ascenseur et de rentrer dans le logement en chaussure ", 15, 45);
    doc.text("de ski ni de les stocker sur balcon ou couloir.", 15, 50); 
    doc.setFontSize(13);
    doc.setFont("arial", "bold"); 
    doc.text("État des lieux contradictoire", 15, 70);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("L'état des lieux a fait l'objet d'un document dressé en autant d'exemplaires qu'il y a de parties", 15, 75);
    doc.text("soit ....2....exemplaires. Il est annexé au présent contrat.", 15, 80); //juste les lignes
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Sanitaires :", 15, 90);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("[X] Lavabo(s)    [X] WC", 15, 95);
    doc.text("[X] Douche(s)   [X] Évier un bac", 15, 100);  //juste les lignes
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Électroménager présent :", 15, 110);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("[X] Réfrigérateur    [X] Plaque cuisson    [X] Appareil à raclette    [X] Plancha", 15, 115);
    doc.text("[X] Four                  [X] Micro-ondes       [X] Grille-pain                [X] Lave-vaisselle 10 couverts", 15, 120);
    doc.text("[X] Aspirateur         [X] Fer à repasser     [X] TV Écran plat           [X] Cafetière Nespresso", 15, 125);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Mobilier (nombre de lits à une ou deux places, les meubles les plus importants):", 15, 135);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("• 1 Lit de 140x200 dans la chambre 1 lit BZ dans le salon (couchage 140x200, 1 lit d’appoint 70x190", 15, 140);
    doc.text("• 1 lit de 140 x 200 sur la mezzanine", 15, 145);
    doc.text("• ...............................................................................................................................", 15, 150);
    doc.text("• ...............................................................................................................................", 15, 155);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Linge fournis :", 15, 165);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("[X] Couverture(s)             [X] Nappe(s)", 15, 175);
    doc.text("[X]  Autre(s) (préciser la présence de serviettes de toilette, torchons à vaisselle, serviettes de table  ", 15, 180);
    doc.text("et tout autre renseignement de nature à permettre au locataire de constituer son trousseau) ", 15, 185);
    doc.setFont("arial", "bold");
    doc.text('Le linge de maison n’est pas fourni ', 15, 195)
    doc.setFont("arial", "normal");
    doc.text('    (Torchons serviettes de toilette draps).', doc.getTextWidth("Le linge de maison n’est pas fourni") + 15, 195);
    doc.text("Est fourni :", 15, 200);
    doc.text('Allaise jetables pour protéger tous les matelas obligatoire a mettre en place sur l’ensemble des ', 15, 205)
    doc.text('literies pour plus d’hygiène', 15, 210)
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Vaisselle", 15, 220);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("La vaisselle et les ustensiles sont suffisants pour ......7...... personnes.", 15, 225);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Réseaux fournis :", 15, 235);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("[X] Eau froide    [X] Eau chaude    [X] Chauffage électrique    [X] Sèche-serviettes Salle de Bain", 15, 240);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Inventaire contradictoire", 15, 250);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("La présente location étant consentie et acceptée en meublé, un inventaire contradictoire des meubles", 15, 255);
    doc.text("sera établi lors de la remise des clés au locataire et lors de la restitution de celles-ci. L'inventaire ", 15, 260);
    doc.text("sera annexé au présent contrat. Le preneur sera responsable de toute détérioration ou perte pouvant", 15, 265);
    doc.text('survenir à ce mobilier.', 15, 270)
    // début troisième page
    doc.addPage();
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Durée de la location", 15, 20);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("La présente location est consentie et acceptée pour une durée d’une semaine (du samedi au", 15, 25);
    doc.text(`samedi) : Du ${currentWeek.start} au ${currentWeek.end}`, 15, 30);
    doc.text("En aucun cas, elle ne pourra être prorogée, sauf accord préalable et écrit du bailleur.", 15, 40);
    doc.text("Le contrat initial ou le contrat prorogé ne pourront porter la durée de la location à plus de quatre", 15, 45);
    doc.text("vingt jours maximum. Pour la prise de possession des lieux et les formalités d’usage (état des lieux,", 15, 50);
    doc.text("inventaire, remise des clés, paiement des sommes prévues à cette date),", 15, 55);
    doc.text("Arrivée et possession de l’appartement le samedi prévu après 16H et départ obligatoire le samedi", 15, 65);
    doc.text("suivant avant 10H.", 15, 70);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Loyer / charges", 15, 80);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text(`La présente location est consentie et acceptée moyennant ${currentWeek.loyer_brut} euros charges comprises.`, 15, 85);
    doc.text(`Nombre de personnes ADULTES occupant le logement (+ de 18 ans) : ${currentWeek.nb_personnes}. `, 15, 95);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Taxe de séjour", 15, 105);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text(`La taxe de séjour s’élève à 1 euro par nuitée et par adulte soit : 1 x ${currentWeek.nb_personnes} x 7 = ${currentWeek.taxe_sejour} euros qui sera remis à`, 15, 110);//faire les formules de merde...
    doc.text("l’Office de Tourisme du Praz de Lys.", 15, 115);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Dépôt de garantie", 15, 125);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("- A titre de garantie et en cautionnement des dégâts qui pourraient être causés au local ou bien au", 15, 130);
    doc.text("mobilier et/ou aux objets garnissant les lieux, le locataire versera, à la signature de ce contrat, la", 15, 135);
    doc.text("somme de (en toutes lettres): 500 euros, cinq cents euros par chèque.", 15, 140);
    doc.text("Cette somme, non productive d’intérêts, sera restituée dès la preuve faite par le locataire que :", 15, 145);
    doc.text("- aucun meuble, objet n’est absent, dégradé ni sali, ou bien, si tel est le cas, sa remise en état ou son ", 15, 150);
    doc.text("remplacement par l’identique est convenu avec le bailleur qui l’a accepté ;", 15, 155);
    doc.text("- les lieux n’ont subi aucune dégradation et sont remis en état propre (placards, poubelles et", 15, 160);
    doc.text("réfrigérateurs vides de déchets, sanitaires, appareils électroménagers, vaisselle, micro onde nettoyé,", 15, 165);
    doc.text("etc ...).", 15, 170);
    doc.text("Si ce cautionnement s’avérait insuffisant, le locataire s’engage d’ores et déjà à en parfaire la", 15, 175);
    doc.text("somme.", 15, 180);
    doc.text("Destruction du dépôt de garantie 1 mois après avoir quitté le logement en accord ensemble suite à ", 15, 185);
    doc.text("la restitution du logement et qu’aucun souci n’ayant été constaté.", 15, 190);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Échéancier de paiement", 15, 200);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("Le jour de la signature des présentes, il est versé par le locataire la somme de :", 15, 205);
    doc.text(`-   ${formatNumber(currentWeek.montant_arrhes)} euros par virement bancaire pour la réservation (25% du montant total : ${calculArrhes} euros + ${currentWeek.taxe_sejour}`, 22, 215);
    doc.text(`euros de Taxe de séjour) et ${formatNumber(currentWeek.reste_du)}  euros avant le ${moinsUnMoisStr} par virement bancaire.`, 26, 220);
    doc.text("-   500 euros de dépôt de Garantie en chèque à la signature de ce contrat qui sera détruit au max", 22, 230);
    doc.text("1 mois après la location si le logement est rendu sans aucune anomalie. (vol, casse)", 26, 235);
    doc.text(`avant le ${plusUnMoisStr}.`, 25, 240);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("Élection de domicile", 15, 245);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("Pour l'exécution des présentes et de leur suite, le bailleur fait élection de domicile en sa demeure et", 15, 250);
    doc.text("le locataire dans les lieux loués.", 15, 255);
    doc.text(`Fait à Cléon, ${currentWeek.date_contrat} en 2 originaux dont un remis au(x) locataire(s).`, 15, 260);
    doc.text("Le(s) locataires(s)                  Le(s) bailleur(s)", 15, 270);
    doc.text("(Faire précéder chaque signature de la mention manuscrite: \"Lu et approuvé, bon pour accord\").", 15, 275);
    doc.addPage();
    doc.setFontSize(20);
    doc.setFont("arial", "bold"); // Mettre la police en gras
    doc.text("LES CONDITIONS GÉNÉALES DU CONTRAT", doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' }); // Centrer le texte à Y=40
    doc.setFontSize(13);
    doc.text("1) DUREE DU CONTRAT", 15, 60);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("Le bail est consenti pour une durée fixée aux CONDITIONS PARTICULIERES du présent contrat.", 15, 65);
    doc.setFont("arial", "bold");
    doc.setFontSize(13);
    doc.text("2) LOYER, CHARGES ET DEPOT DE GARANTIE", 15, 75);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("Le montant du loyer, des charges et du dépôt de garantie sont indiqués au chapitre Loyer / charges", 15, 80);
    doc.text("du présent contrat.", 15, 85);
    doc.text("Des arrhes en vue de réserver le logement peuvent être demandés antérieurement.", 15, 90);
    doc.text("La restitution de tout ou partie du dépôt de garantie aura lieu dans les huit jours suivant", 15, 95);
    doc.text("l’établissement de l’état des lieux de sortie et de la remise", 15, 100);
    doc.text("des clés en fin de séjour et sera fonction de l’état du logement.", 15, 105);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("3) OBLIGATIONS DU BAILLEUR", 15, 115);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("Le bailleur est obligé :", 15, 120);
    doc.text("a) de délivrer le logement en bon état d'usage et de réparation (sauf stipulation particulière", 15, 125);
    doc.text("concernant les travaux pouvant être pris en charge par le locataire), ainsi que les équipements", 15, 130);
    doc.text("mentionnés au présent contrat en bon état de fonctionnement.", 15, 135);
    doc.text("b) d'assurer au locataire une jouissance paisible et la garantie des vices ou défauts de nature à y faire", 15, 140);
    doc.text("obstacle.", 15, 145);
    doc.text("d) de maintenir les locaux en état de servir à l'usage prévu par le contrat en effectuant les", 15, 150);
    doc.text("réparations autres que locatives.", 15, 155);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("4) OBLIGATIONS DU LOCATAIRE", 15, 165);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("Le locataire est obligé :", 15, 170);
    doc.text("a) de payer le loyer et les charges récupérables aux termes convenus. Le paiement mensuel est de", 15, 175);
    doc.text("droit si le locataire en fait la demande.", 15, 180);
    doc.text("b) d'user paisiblement des locaux loués en respectant leur destination contractuelle.", 15, 185);
    doc.text("c) de répondre des dégradations ou des pertes survenues pendant la durée du contrat dans les locaux", 15, 190);
    doc.text("dont il a la jouissance exclusive, à moins qu’il ne prouve qu’elles ont eu lieu par cas de force", 15, 195);
    doc.text("majeure, par la faute du bailleur ou par le fait d’un tiers qu’il n’a pas introduit dans le logement.", 15, 200);
    doc.text("d) de prendre à sa charge l’entretien courant du logement et des équipements, les menues", 15, 205);
    doc.text("réparations et l'ensemble des réparations incombant au locataire telles que définies par le décret", 15, 210);
    doc.text("n°87-712 du 26 août 1987, sauf si elles sont occasionnées par vétusté, malfaçon, vice de", 15, 215);
    doc.text("construction, cas fortuit ou force majeure.", 15, 220);
    doc.text("e) de ne pas transformer les locaux et équipements loués.", 15, 225);
    doc.text("f) de s’assurer convenablement contre les risques locatifs, l’incendie, les explosions, les dégâts des", 15, 230);
    doc.text("eaux ; et à en justifier lors de la remise des clés", 15, 235);
    doc.text("g) à laisser le bailleur, son mandataire ou le syndic de l’immeuble entrer dans les lieux en cas de", 15, 240);
    doc.text("grandes nécessité.", 15, 245);
    doc.addPage();
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("5) CAUTIONNEMENT ", 15, 30);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("Le bailleur peut souhaiter qu'un tiers se porte caution en garantissant l'exécution des obligations du", 15, 35);
    doc.text("contrat de location en cas de défaillance éventuelle du locataire. A compter du 01/09/94 plusieurs ", 15, 40);
    doc.text("formalités sont obligatoires sous peine d'entraîner la nullité du cautionnement. ", 15, 45);
    doc.text("Le tiers qui se porte caution doit indiquer de sa main sur l'acte de caution :", 15, 50);
    doc.text("- le montant du loyer ", 15, 55);
    doc.text("- les conditions de sa révision, le cas échéant,", 15, 60);
    doc.text("- reconnaître la nature et l’importance de l’engagement,", 15, 65);
    doc.text("- indiquer la durée de l'engagement.", 15, 70);
    doc.text("A défaut d'indication de durée, ou si celle-ci est stipulée indéterminée la caution peut résilier", 15, 75);
    doc.text("unilatéralement son engagement. Cette résiliation après avoir été notifiée au bailleur prend effet au ", 15, 80);
    doc.text("terme du contrat de location, soit à la fin du contrat initial, ou renouvelé, ou tacitement reconduit.", 15, 85);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("6) CLAUSE RESOLUTOIRE", 15, 95);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("Il est expressément convenu qu'à défaut de paiement au terme convenu de tout ou partie du loyer, ", 15, 100);
    doc.text("des charges du dépôt de garantie, la présente location sera résiliée de plein droit. ", 15, 105);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("7) CLAUSE PÉNALE", 15, 115);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("Sans préjudice de la mise en œuvre éventuelle de la clause résolutoire et de la demande d’allocation", 15, 120);
    doc.text("de dommages et intérêts, en vertu de l’article 1226 du Code civil relatif aux clauses pénales, les ", 15, 125);
    doc.text("parties conviennent qu’un défaut de paiement du loyer ou des charges entraînera une majoration ", 15, 130);
    doc.text("de 15% des sommes dues. Cette clause pénale produira ses effets en cas d’inaction du preneur au", 15, 135);
    doc.text("delà de sept jours à compter de l’envoi, par le bailleur, d’une mise en demeure par lettre", 15, 140);
    doc.text("recommandée avec AR. ", 15, 145);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("8) ETAT DES LIEUX", 15, 155);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("A défaut d'état d'entrée ou de sortie des lieux établi volontairement et contradictoirement, la partie", 15, 160);
    doc.text("la plus diligente est en droit d'en faire dresser un par huissier, à frais partagés.", 15, 165);
    doc.text("A défaut d'état des lieux, la présomption de l'article 1731 du Code Civil ne peut être invoquée par", 15, 170);
    doc.text("celle des parties qui a fait obstacle à son établissement. ", 15, 175);
    doc.text("Pendant le premier mois de la période de chauffe, le locataire peut demander que l'état des lieux soit", 15, 180);
    doc.text("complété par l'état des éléments de chauffage. ", 15, 185);
    doc.text("Le logement doit être rendu propre, nettoyé, poubelle vidée", 15, 190);
    doc.text("Un forfait ménage de 100 euros sera déduit de la caution si cela n’est pas respecté. Encaissement", 15, 195);
    doc.text("des 500 euros et restitution d’un nouveau chèque de 400 euros", 15, 200);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("9) ELECTION DE DOMICILE ", 15, 210);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("Pour l'exécution des obligations visées au présent contrat, le bailleur fait élection de domicile en sa", 15, 215);
    doc.text("demeure et le locataire dans les lieux loués. ", 15, 220);
    doc.setFontSize(13);
    doc.setFont("arial", "bold");
    doc.text("10) ANNULATION", 15, 230);
    doc.setFont("arial", "normal");
    doc.setFontSize(12);
    doc.text("En cas d’annulation du locataire sauf en cas de force majeur celui-ci perd l’intégralité de ses arrhes", 15, 235);
    doc.text("et de sa caution qui lui sera remboursée que si et seulement si un nouveau locataire occupera le", 15, 240);
    doc.text("logement à cette même date.", 15, 245);
    doc.text("Le blocage du pays ou de la région du locataire en cas de COVID est une FORCE MAJEUR", 15, 250);
        // Créer une nouvelle page pour l'image
        doc.addPage(); // Ajoute une nouvelle page
        // Charger l'image
        const img = new Image();
        img.src = 'image2.jpg'; // Chemin de ton image
        img.onload = function() {
            // Ajouter l'image à la deuxième page
            doc.addImage(img, 'PNG', 0, 0, 210, 297); // x, y, width, height
            // Sauvegarder le PDF
            doc.save(`Contrat ${currentWeek.nom}.pdf`);
        };
        img.onerror = function() {
            console.error("L'image n'a pas pu être chargée. Vérifiez le chemin.");
        };
    }

        // Event Listeners
        document.getElementById('loginButton').addEventListener('click', login);
        document.getElementById('password').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') login();
        });

        document.getElementById('prevTabBtn').addEventListener('click', () => {
            if (currentTabIndex > 0) {
                currentTabIndex--;
                fetchData();
            }
        });

        document.getElementById('nextTabBtn').addEventListener('click', () => {
            if (currentTabIndex < collections.length - 1) {
                currentTabIndex++;
                fetchData();
            }
        });

        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('modal').style.display = 'none';
            document.querySelector('.btnprev').style.display = 'block';
            document.querySelector('.btnnext').style.display = 'block';
        });

        document.getElementById('editWeekBtn').addEventListener('click', showModifmodal);
        document.getElementById('generatePdfBtn').addEventListener('click', generatePdf);

        // Event listeners pour la modale d'édition
        document.getElementById('cancel-edit').addEventListener('click', () => {
            document.getElementById('Modifmodal').style.display = 'none';
            document.getElementById('modal').style.display = 'flex';
        });

        document.getElementById('save-edit').addEventListener('click', saveWeekChanges);

        // Recalcul automatique des montants lors de la modification
        document.getElementById('edit-nb-personnes').addEventListener('input', updateCalculatedFields);
        document.getElementById('edit-loyer-brut').addEventListener('input', updateCalculatedFields);

        // Et corrigez la fonction updateCalculatedFields :
function updateCalculatedFields() {
    const nbPersonnes = parseInt(document.getElementById('edit-nb-personnes').value) || 0;
    const loyerBrut = parseFloat(document.getElementById('edit-loyer-brut').value) || 0;
    const taxe = nbPersonnes * 7;
    const loyerTotal = loyerBrut + taxe;
    const montantArrhes = (loyerBrut * 0.25) + taxe; // Correction ici
    const resteDu = loyerTotal - montantArrhes;

    console.log(`Taxe: ${formatNumber(taxe)}€, Total: ${formatNumber(loyerTotal)}€, Arrhes: ${formatNumber(montantArrhes)}€, Reste: ${formatNumber(resteDu)}€`);
}

        // Initialisation
        if (!checkSession()) {
            document.getElementById('calendarContainer').classList.add('active');
        }

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log("Service Worker enregistré !"))
                .catch((error) => console.log("Erreur Service Worker :", error));
        }
    </script>
</body>
</html>
